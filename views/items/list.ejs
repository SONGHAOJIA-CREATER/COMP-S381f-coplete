<%- include('../partials/header', { title: tr('物品广场', 'Marketplace'), activeNav: 'items' }) %>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
  <div>
    <h1 class="h3 fw-bold mb-1"><%= tr('我的校园闲置', 'My campus marketplace') %></h1>
    <p class="text-muted small mb-0">
      <%= tr('支持关键词 + 分类 + 价格区间多条件筛选，还能按热门 API 获取更多数据。', 'Search by keyword, category and price filters—plus hot-item APIs for more insights.') %>
    </p>
  </div>
  <a href="/items/new" class="btn btn-primary">+ <%= tr('发布新物品', 'Post new item') %></a>
</div>

<form class="card shadow-sm p-3 mb-4" method="GET" action="/items" id="filterForm">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label text-muted small"><%= tr('关键词', 'Keyword') %></label>
      <input
        type="text"
        class="form-control"
        name="search"
        value="<%= filters.search %>"
        placeholder="<%= tr('标题或描述', 'Title or description') %>"
      />
    </div>
    <div class="col-md-3">
      <label class="form-label text-muted small"><%= tr('分类', 'Category') %></label>
      <select class="form-select" name="category">
        <option value="全部"><%= tr('全部', 'All categories') %></option>
        <% categories.forEach((category) => { %>
        <option value="<%= category %>" <%= filters.category === category ? 'selected' : '' %>>
          <%= categoryLabel(category) %>
        </option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label text-muted small"><%= tr('最低价格', 'Min price') %></label>
      <input type="number" min="0" class="form-control" name="minPrice" value="<%= filters.minPrice %>" />
    </div>
    <div class="col-md-2">
      <label class="form-label text-muted small"><%= tr('最高价格', 'Max price') %></label>
      <input type="number" min="0" class="form-control" name="maxPrice" value="<%= filters.maxPrice %>" />
    </div>
    <div class="col-md-2 d-flex align-items-end gap-2">
      <button class="btn btn-outline-primary w-100" type="submit"><%= tr('筛选', 'Filter') %></button>
      <a class="btn btn-outline-secondary" href="/items"><%= tr('重置', 'Reset') %></a>
    </div>
  </div>
</form>

<div class="row g-4">
  <% if (items.length === 0) { %>
  <div class="col-12 text-center text-muted py-5"><%= tr('没有符合条件的物品，换个条件试试？', 'No items match—try different filters!') %></div>
  <% } %>
  <% items.forEach((item) => { %>
  <div class="col-md-4">
    <div class="card h-100 shadow-sm">
      <img
        src="<%= item.imagePath ? '/' + item.imagePath : 'https://placehold.co/600x400?text=No+Image' %>"
        class="card-img-top object-fit-cover"
        alt="<%= item.title %>"
      />
      <div class="card-body d-flex flex-column">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="badge bg-primary-subtle text-primary"><%= categoryLabel(item.category) %></span>
          <span class="small text-muted"><%= item.seller.username %></span>
        </div>
        <h5 class="card-title mb-2"><%= item.title %></h5>
        <p class="text-muted small flex-grow-1"><%= item.description %></p>
        <div class="d-flex flex-column gap-2 mt-3">
          <span class="fw-bold text-primary fs-5">¥ <%= item.price.toFixed(2) %></span>
          <div class="d-flex gap-2">
            <a href="/items/<%= item._id %>" class="btn btn-outline-secondary btn-sm w-100"><%= tr('详情', 'Details') %></a>
            <% if (currentUser && item.seller._id.toString() === currentUser.id) { %>
            <a href="/items/<%= item._id %>/edit" class="btn btn-primary btn-sm"><%= tr('编辑', 'Edit') %></a>
            <form action="/items/<%= item._id %>?_method=DELETE" method="POST" class="w-100" onsubmit="return confirmDelete()">
              <button class="btn btn-outline-danger btn-sm w-100" type="submit"><%= tr('删除', 'Delete') %></button>
            </form>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% }) %>
</div>

<%- include('../partials/footer') %>

